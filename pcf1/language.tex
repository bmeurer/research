\documentclass[12pt,a4paper]{report}

\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amstext}
\usepackage{array}
\usepackage[american]{babel}
\usepackage{color}
\usepackage{enumerate}
\usepackage[a4paper,%
            colorlinks=false,%
            final,%
            pdfkeywords={},%
            pdftitle={},%
            pdfauthor={Benedikt Meurer},%
            pdfsubject={},%
            pdfdisplaydoctitle=true]{hyperref}
\usepackage[latin1]{inputenc}
\usepackage{latexsym}
\usepackage[final]{listings}
\usepackage{makeidx}
\usepackage[standard,thmmarks]{ntheorem}
\usepackage{stmaryrd}
\usepackage{url}

%% LaTeX macros
\include{macros}

% TODO
\newcommand{\CExp}{\nstyle{CExp}}
\newcommand{\CVal}{\nstyle{CVal}}
\newcommand{\Conf}{\nstyle{Conf}}
\newcommand{\Sto}{\nstyle{Sto}}
\newcommand{\loc}{\nstyle{loc}}
\newcommand{\sto}{\nstyle{sto}}
\newcommand{\val}{\nstyle{val}}
\newcommand{\z}{\nstyle{int}}
\newcommand{\DEF}{\nstyle{DEF}}
\newcommand{\OUT}{\nstyle{OUT}}
\newcommand{\PERM}{\nstyle{PERM}}
\newcommand{\INV}{\nstyle{INV}}
\newcommand{\id}{\nstyle{id}}
\newcommand{\I}{\mathcal{I}}
\newcommand{\returns}[2]{\ensuremath{\mathbf{returns}\,{#1}.\,{#2}}}


\begin{document}


%%
%% The programming language
%%

\chapter{The programming language}

As target language, we use eager PCF with the usual primitive types and imperative concepts.


%%
%% Abstract syntax
%%

\section{Abstract syntax}

We assume that infinite sets of variables $x \in \Var$ and locations $l \in \Loc$ are given;
variables are used to abstract expressions, locations are used to address memory cells.
Expressions are considered equal modulo renaming of bound variables.
$\Bool=\{\true,\false\}$ is the set of boolean constants $b$, $\Int$ is the set of integer
constants $z$; we do not distinguish between integer values and their program representation.

We assume an infinite set $\Loc$ of locations $l$.

\begin{definition}[Expressions]
  The set $\Op$ of {\em operators} $\op$ and the set $\Const$ of {\em constants} $c$
  are defined by the grammars
  \[\GRbeg
    \op \GRis + \GRmid - \GRmid * \GRmid = \GRmid < \GRmid > \GRmid \le \GRmid \ge \\
    c \GRis z \GRmid b \GRmid \unit \GRmid \cref \GRmid !
             \GRmid \assign \GRmid \fix,
  \GRend\]
  the set $\Exp$ of {\em expressions} $e$ is defined by
  \[\GRbeg
    e \GRis c \GRmid x \GRmid l \GRmid \abstr{x}{e} \GRmid \app{e_1}{e_2}
           \GRmid \ifte{e_0}{e_1}{e_2}
  \GRend\]
  and the set $\Val \subseteq \Exp$ of {\em values} $v$ is defined by
  \[\GRbeg
    v \GRis c \GRmid x \GRmid l \GRmid \abstr{x}{e} \GRmid \app{\op}{v} \GRmid \app{\assign}{v}
  \GRend\]
\end{definition}

$\free{e}$ denotes the set of free variables and $\locns{e}$ denotes the set of locations in the
expression $e$. We say that an expression $e$ is a {\em program} if both $\free{e}=\emptyset$
and $\locns{e}=\emptyset$ holds, that is if $e$ contains neither unbound variables nor
locations (i.e. memory addresses in terms of the underlying machine). We demand that all expressions
considered for the logic later are valid programs (i.e. programmers aren't permitted to access
abritrary memory locations).


%%
%% Static semantics
%%

\section{Static semantics}

The static semantics of the programming language are defined by the typing relation
$\tj{e}{\tau}$, with types $\tau$ as follows:

\begin{definition}[Types]
  The set $\Type$ of all {\em types} $\tau$ is defined by the context-free grammar below:
  \[\GRbeg
    \tau  \GRis \tbool \GRmid \tint \GRmid \tunit
          \GRal \tref{\tint}
          \GRal \tarrow{\tau_1}{\tau_2}
  \GRend\]
\end{definition}

We don't want to fiddle with type environments and store typings, hence we assume that
the elements of $\Var$ and $\Loc$ are already tagged with types. Therefore for every
type $\tau\in\Type$, let $\Var^\tau$ denote the set of variables $\tau$ and $\Loc^\tau$ the
set of locations of type $\tau$. Then $\Var=\bigcup_{\tau\in\Type}\Var^\tau$ and
$\Loc=\bigcup_{\tau\in\Type}\Loc^\tau$, where the $\Var^\tau$ and $\Loc^\tau$ are
required to be disjoint. We write $x^\tau$ to identify elements of $\Var^\tau$ and
$l^\tau$ for elements of $\Loc^\tau$.

\begin{definition}[Typing relation]
  A {\em typing judgement} is a formula $\tj{e}{\tau}$ with
  $e\in\Exp$ and $\tau\in\Type$. A typing judgement is said to
  be valid if it was derived using the typing rules {\bf defined
  elsewhere}.
\end{definition}

The set $\Exp^\tau = \{e\in\Exp\,|\,\tj{e}{\tau}\}$ includes all expressions of type $\tau$,
$\CExp^\tau = \{e\in\Exp^\tau\,|\,\free{e}=\emptyset\}$ is the subset of closed of expressions of
type $\tau$ and $\CExp = \bigcup_{\tau\in\Type} \CExp^\tau$ is the set of all well-typed, closed
expressions. Likewise we define $\Val^\tau = \Exp^\tau\cap\Val$, $\CVal^\tau = \CExp^\tau \cap \Val$
and $\CVal = \CExp \cap \Val$.


%%
%% Operational semantics
%%

\section{Operational semantics}

\begin{definition}[Store] \label{definition:Store} \
  \begin{enumerate}
    \item A {\em store} is a partial function $s:\Loc \pto \CVal$ with
          \begin{enumerate}
            \item $s(\Loc^\tau) \subseteq \CVal^\tau$ for every $\tau\in\Type$ and
            \item $\locns{s(\Loc)} \subseteq \dom{s}$.
          \end{enumerate}

    \item For each $L\subseteq \Loc$ the set of {\em $L$-stores} is defined as
          \[\begin{array}{l}
            \Store_L = \{s\,|\,\text{$s$ is a store with $L\subseteq\dom{s}$}\}.
          \end{array}\]

    \item $\Store = \bigcup_{L\subseteq\Loc} \Store_L$ denotes the set of all {\em stores}.
  \end{enumerate}
\end{definition}

We thereby require stores to be well-typed and closed by definition, i.e. we don't permit {\em dangling
references} within stores.

\begin{definition}[Configuration]
  Let $e\in\CExp$ and $s\in\Store$. The pair $(e,s)$ is a {\em configuration}
  if $\locns{e} \subseteq \dom{s}$.
\end{definition}

The stores $s$ are already guarantied to be closed due to definition~\ref{definition:Store} and
now expressions that appear as part of an evaluation are also required to be closed, i.e. do not
include {\em dangling references} to unallocated store cells.

\begin{definition}[Small step semantics]
  Let $e,e'\in\Exp$ and $s,s'\in\Store$. A {\em small step} is a formula
  $(e,s) \to (e',s')$. A small step is said to be valid if it was derived with
  the small rules given {\bf somewhere else}.
\end{definition}

\begin{definition}[Big step semantics]
  Let $e\in\Exp$, $v\in\Val$ and $s,s'\in\Store$. A {\em big step} is a formula
  $(e,s) \Downarrow (v,s')$. A big step is said to be valid if it was derived with the
  big step rules given {\bf somewhere else}.
\end{definition}

\begin{corollary}
  Let $e\in\Exp$, $v\in\Val$ and $s,s'\in\Store$. If $(e,s)$ is a configuration
  and $(e,s) \xrightarrow* (v,s')$, then
  \begin{enumerate}
    \item $(v,s')$ is also a configuration, and
    \item $\dom{s} \subseteq \dom{s'}$.
  \end{enumerate}
\end{corollary}

\begin{proof}
  Straight forward induction.
\end{proof}

The small step semantic is thereby well-defined with regard to configurations, i.e. it preserves
the configuration property. We assume that type safety holds for the semantics (see Pierce, {\bf TODO}).

\begin{lemma} \label{lemma:Small_steps_and_graph_of_stores}
  Let $\tau\in\Type$, $e\in\CExp^\tau\setminus\Val$, $s,\hat{s}\in\Store_{\locns{e}}$.
  If $\grph{s} \subseteq \grph{\hat{s}}$ then there exist $e',\hat{e}'\in\CExp^\tau$
  and $s',\hat{s}'\in\Store$ such that
  \begin{enumerate}
    \item $(e,s) \to (e',s')$,
    \item $(e,\hat{s}) \to (\hat{e}',\hat{s}')$ and
    \item $\grph{s'} \subseteq \grph{\hat{s}'}$.
  \end{enumerate}
\end{lemma}

\begin{proof}
  By structural induction on $e$. We consider only the case for the application,
  hence let $e = \app{e_1}{e_2}$.
  \begin{itemize}
    \item $e_1 \not\in \Val$, then by induction hypothesis, we have
          $e_1',\hat{e_1}'\in\CExp^\tau$ and $s',\hat{s}'\in\Store$ such that
          $(e_1,s) \to (e_1',s')$, $(e_1,\hat{s}) \to (\hat{e_1}',\hat{s}')$
          and $\grph{s'} \subseteq \grph{\hat{s}'}$. With \RN{App-Left} we
          conclude $(\app{e_1}{e_2},s) \to (\app{e_1'}{e_2},s')$ and
          $(\app{e_1}{e_2},\hat{s}) \to (\app{\hat{e_1}'}{e_2},\hat{s}')$.

    \item $e_1 \in \Val, e_2 \not\in \Val$ analogue to the above with \RN{App-Right}.

    \item $e_1 = \cref, e_2=v\in \Val$, choose $e' = \hat{e}' = l \not\in \dom{\hat{s}} \subseteq \dom{s}$
          and thereby $(e,s) \to (l,s[v/l])$ and $(e,\hat{s}) \to (l,\hat{s}[v/l])$ with \RN{Ref} and
          $\grph{s'} = \grph{s} \cup \{(l,v)\} \subseteq \grph{\hat{s}} \cup \{(l,v)\} = \grph{\hat{s}'}$.

    \item $e_1 = (\app{\assign}{l}), e_2 = v \in \Val$ where $l \in \dom{s}\cap\dom{\hat{s}}$, then
          $(e,s) \to (\unit,s[v/l])$ and $(e,\hat{s}) \to (\unit,\hat{s}[v/l])$ with \RN{Assign} and
          $\grph{s[v/l]}=\grph{s}\cup\{(l,v)\} \subseteq \grph{\hat{s}}\cup\{(l,v)\}=\grph{\hat{s}[v/l]}$.
  \end{itemize}
  The remaining cases are quite similar.
\end{proof}

\begin{corollary}
  If $(e,s)$ has a terminating computation and $\grph{s} \subseteq \grph{s_1}$ then
  there exist $v\in\CVal^\tau$, $s',s_1'\in\Store$ with
  \begin{enumerate}
    \item $(e,s) \xrightarrow* (v,s')$
    \item $(e,s_1) \xrightarrow* (v,s_1')$
    \item $\grph{s'} \subseteq \grph{s_1'}$
  \end{enumerate}
\end{corollary}

\begin{proof}
  Follows immediately with lemma~\ref{lemma:Small_steps_and_graph_of_stores}.
\end{proof}


%%
%% The assertion language
%%

\chapter{The assertion language}


%%
%% Syntax of the assertion language
%%

\section{Syntax of the assertion language}


%%
%% Semantics of the logic
%%

\section{Semantics of the logic}

Let $(W,\subseteq) = (\powersetfin{Loc},\subseteq)$ be the partial order of possible `worlds'.


%%
%% Reachability
%%

\subsection{Reachability}

\begin{definition}[Reachability]
  Let $L\in W$ and $s\in\Store_L$. By induction we define sets $\reachn{i}{L}{s} \subseteq \Loc$
  \begin{itemize}
    \item $\reachn{0}{L}{s} = L$
    \item $\reachn{i+1}{L}{s} = \reachn{i}{L}{s} \cup \bigcup_{l\in\reachn{i}{L}{s}} \locns{s(l)}$.
  \end{itemize}
  The set $\reach{L}{s} = \bigcup_{i\in\N} \reachn{i}{L}{s}$ includes all locations in $s$ reachable
  by $L$.
\end{definition}

Since a store $s\in\Store_L$ is always closed by definition, it is obvious that
$\reach{L}{s} \subseteq \dom{s} \in  W$ holds.

\begin{lemma}
  For all $L,L'\in W$ with $L \subseteq L'$ and $s,s'\in\Store_{L'}$ we have:
  \begin{enumerate}
    \item $\Store_{L'} \subseteq \Store_L$
    \item $\reach{L}{s} \subseteq \reach{L'}{s}$
    \item If $\reach{L'}{s} = \reach{L'}{s'}$ and $s(l) = s'(l)$ for every $l\in\reach{L'}{s}$,
          then $\reach{L}{s} = \reach{L}{s'}$.
  \end{enumerate}
\end{lemma}

\begin{proof}
  Trivial.
\end{proof}

\begin{definition}[$L$-equivalence, $L$-definability]
  Given a world $L \in W$ we define:
  \begin{enumerate}
    \item Two stores $s,s'\in\Store_L$ are {\em $L$-equivalent}, denoted $s \equiv_L s'$, if
          \begin{itemize}
            \item $\reach{L}{s} = \reach{L}{s'}$ and
            \item $\forall l\in\reach{s}{L}.\,s(l)=s'(l)$.
          \end{itemize}

    \item A predicate $\phi:\Store \pto \Bool$ with $\Store_L = \dom{\phi}$ is said to be
          {\em $L$-definable} if $\app{\phi}{s} = \app{\phi}{s'}$ for all stores
          $s,s'\in\Store_L$ with $s \equiv_L s'$. $\DEF_L$ denotes the set of all $L$-definable
          predicates.
  \end{enumerate}
\end{definition}


%%
%% Permutability
%%

\subsection{Permutability}

\begin{definition}[Permutation]
  A {\em permutation} is a total, bijective function $\mu:\Loc\to\Loc$ with
  $\mu\,(\Loc^\tau)=\Loc^\tau$ for each $\tau\in\Type$.
  For a given $L \subseteq \Loc$ we define $\PERM_L = \{\mu\,|\,(\mu|L) = \id_L\}$
  and $\PERM = \bigcup_{L\subseteq\Loc} \PERM_L$.
\end{definition}

For every permutation $\mu \in \PERM_L$ we define functions 
\begin{itemize}
  \item $\mu^\Exp:\Exp \to \Exp, e \mapsto e\mu$ and
  \item $\mu^\Sto:\Store \to \Store, s \mapsto \mu^\Exp \circ s \circ \mu^{-1}$,
\end{itemize}
where $e\mu$ is inductively defined as follows:
\begin{itemize}
  \item $c\mu = c$ for every $c \in \Const$
  \item $x\mu = x$ for every $x \in \Var$
  \item $l\mu = \mu\,(l)$ for every $l \in \Loc$
  \item $(\app{e_1}{e_2})\mu = \app{(e_1\mu)}{(e_2\mu)}$
  \item $(\abstr{x}{e})\mu = \abstr{x}{(e\mu)}$
  \item $(\ifte{e_0}{e_1}{e_2})\mu = \ifte{(e_0\mu)}{(e_1\mu)}{(e_2\mu)}$
\end{itemize}

Obviously $\mu^\Exp$ is well-defined. For $\mu^\Sto$ assume that $L \in W$ and $s\in\Store_L$,
then $\mu^\Sto\,s = \mu^\Exp \circ s \circ \mu^{-1}$ is closed under locations in
$\dom{\mu^\Sto\,s}$ and
\[\begin{array}{rccccl}
  \dom{\mu^\Sto\,s} &=& \mu(\dom{s}) &\supseteq& \mu(L),
\end{array}\]
thereby $(\mu^\Sto\,s) \in \Store_{\mu(L)}$. Furtheron $\locns{\mu^\Exp(e)} = \mu(\locns{e})$
holds for every $e \in \Exp$.

\begin{lemma}
  Let $L \subseteq \Loc$ and $\mu \in \Perm_L$, then
  \begin{enumerate}
    \item $\forall e\in\Exp.\,\locns{e} \subseteq L \Rightarrow \mu^\Exp\,e = e$
    \item $\forall s\in\Store.\,\dom{s} \subseteq L \Rightarrow \mu^\Sto\,s = s$
  \end{enumerate}
\end{lemma}

\begin{proof}
  Trivial.
\end{proof}

\begin{lemma}
  For every $L \in W$ and $\mu \in \Perm$ we have
  \begin{enumerate}
    \item $\forall s,s'\in\Store.\,s \equiv_{\mu(L)} s'
            \Rightarrow (\mu^\Sto)^{-1}\,s \equiv_L (\mu^\Sto)^{-1}\,s'$
    \item $\forall \phi\in\DEF_L.\, (\phi\circ (\mu^\Sto)^{-1}) \in \DEF_{\mu(L)}$
  \end{enumerate}
\end{lemma}

\begin{proof}
  Let $L' = \mu(L)$.
  \begin{enumerate}
    \item 

    \item Let $\phi\in\DEF_L$, then $\dom{\phi \circ (\mu^\Sto)^{-1}} = \Store_{L'}$. Now
          let $s,s'\in\Store_{L'}$ with $s \equiv_{L'} s'$, then
          \[\begin{array}{rl}
            \Rightarrow & s \equiv_{\mu(L)} s' \\
            \Rightarrow & (\mu^\Sto)^{-1} \, s \equiv_L (\mu^\Sto)^{-1} \, s' \\
            \Rightarrow & \phi\,((\mu^\Sto)^{-1}\, s) = \phi\,((\mu^\Sto)^{-1}\, s')
                          \quad \quad \text{since } \phi \in \DEF_L \\
            \Rightarrow & (\phi\circ (\mu^\Sto)^{-1}) \in \DEF_{L'}
          \end{array}\]
  \end{enumerate}
\end{proof}

\begin{lemma} \label{lemma:Existance_of_permutations_for_small_steps}
  Let $\tau\in\Type$, $e,e',e''\in\CExp^\tau$, $s,s',s''\in\Store_{\locns{e}}$ with
  $(e,s) \to (e',s')$ and $(e,s) \to (e'',s'')$. Then there exists some $\mu \in \PERM_{\dom{s}}$
  such that $\mu^\Exp\,e' = e''$ and $\mu^\Sto\,s' = s''$.
\end{lemma}

\begin{proof}
  $(e,s) \to (e',s')$ and $(e,s) \to (e'',s'')$ requires that both small steps were derived
  using the same rules. Therefore, we can easily prove the lemma by induction on the length
  of the derivation of $(e,s) \to (e',s')$.
  \begin{itemize}
    \item For \RN{Op} we have $e' = e'' \in \Const$ and therefore $\mu^\Exp\,e' = e''$ for every
          $\mu \in \Perm$. Since $\mu^\Sto\,s=s$ for every $\mu \in \Perm_{\dom{s}}$ and $s' = s = s''$,
          we also have $\mu^\Sto\,s' = s''$.

    \item In case of \RN{Ref} we have $e = \cref\,v$, $e' = l'$, $e'' = l''$,
          $s' = s[v/l']$, $s'' = s[v/l'']$ with $l',l''\not\in\dom{s}$. Let
          $\mu \in \Perm_{\dom{s}}$ with $\mu\,l'=l''$, so we have $\mu^\Exp\,e' = e''$ and
          $s''(l'') = v = s'(l') = s'(\mu^{-1}\,l'') = \mu^\Exp\,(s(\mu^{-1}\,l''))$.

    \item \RN{App-Left} implies $e = \app{e_1}{e_2}$, $e' = \app{e_1'}{e_2}$ and $e'' = \app{e_1''}{e_2}$.
          By induction hypothesis there exists a $\mu \in \Perm_{\dom{s}}$ with
          $\mu^\Exp\,e_1' = e_1''$ and $\mu^\Sto\,s' = s''$. Since
          $\locns{e_2} \subseteq \locns{e} \subseteq \dom{s}$ we also have $\mu^\Exp\,e_2 = e_2$
          and thereby $\mu^\Exp\,(\app{e_1'}{e_2}) = \app{e_1''}{e_2}$.
  \end{itemize}
  We omit the other cases, they're similar to the above.
\end{proof}

\begin{corollary}
  Let $\tau\in\Type$, $e\in\CExp^\tau$, $s\in\Store_{\locns{e}}$.
  If $(e,s)$ terminates with $(v',s')$ then all computations for $(e,s)$ terminate with some
  $(v'',s'')$ such that there exists a $\mu \in \PERM_{\dom{s}}$ with
  $\mu^\Exp\,v' = v''$ and $\mu^\Sto\,s' = s''$.
\end{corollary}

\begin{proof}
  Immediate consequence of lemma~\ref{lemma:Existance_of_permutations_for_small_steps}.
\end{proof}


%%
%% Semantic domains
%%

\subsection{Semantic domains}

\begin{definition}[Semantic domains]
  For every type $\pi\in\LType$ we define {\em semantic domains} $\semantic{\pi} = (D^\pi,\I^\pi)$ where
  $D^\pi = \bigcup_{L \in W} D^\pi_L$ and $\I^\pi(\mu) : D^\pi \to D^\pi$ for every $\mu \in \Perm$ by
  \begin{itemize}
    \item $D^\tau_L = \{v\in\CVal^\tau\,|\,\locns{v} = L\}$ \\
          $\I^\tau(\mu): D^\tau \to D^\tau, v \mapsto \mu^\Exp\,v$

    \item $D^\tassn_L = \{ \phi\in\DEF_L\,|\,\forall \mu\in\Perm_L.\,\phi = \phi \circ (\mu^\Sto)^{-1}\}$ \\
          $\I^\tassn(\mu): D^\tassn \to D^\tassn, \phi \mapsto \phi \circ (\mu^\Sto)^{-1}$

    \item $D^{\ttarrow{\theta}{\pi}}_L = \{ \psi: D^\theta \to D^\pi\,|\,
                          \forall L'\in W.\,\psi\,(D^\theta_{L'}) \subseteq D^\pi_{L \cup L'} \\
                          \hspace*{4.2cm} \wedge \forall \mu\in\Perm_L.\,\psi=\mu^\pi\circ\psi\circ(\mu^\theta)^{-1}\}$\\
          $\I^{\ttarrow{\theta}{\pi}}(\mu): D^{\ttarrow{\theta}{\pi}} \to D^{\ttarrow{\theta}{\pi}},
                                            \psi \mapsto \I^\pi(\mu) \circ \psi \circ (\I^\theta(\mu))^{-1}$
  \end{itemize}
\end{definition}

We follow the usual mathematical convention and use $\semantic{\pi}$ not only as a notation
for the semantic domain $(D^\pi,\I^\pi)$ but also for the underlying set $D^\pi$,
hence $\semantic{\pi}_L$ denotes the set $D^\pi_L$. Moreover, we use $\mu^\pi$ as an abbreviation
for $\I^\pi(\mu)$.

\begin{lemma}[Semantic domains] \
  For every $\pi \in \LType$ we have
  \begin{enumerate}
    \item $\forall \mu \in \Perm.\,\mu^\pi\,\semantic{\pi} \subseteq \semantic{\pi}$
    \item $\forall L_1,L_2 \in W.\, \semantic{\pi}_{L_1} \cap \semantic{\pi}_{L_2} \ne \emptyset \Rightarrow L_1=L_2$
    \item $\forall L \in W, \mu \in \Perm_L, d\in \semantic{\pi}_L.\, \mu^\pi\,d = d$
  \end{enumerate}
\end{lemma}

The first proposition ensures that $\I^\pi$ is well defined for every $\pi\in\LType$, the
second states that there exists a unique world $L \in W$ for every $d \in \semantic{\pi}$ and
the last one ensures that elements of $\semantic{\pi}_L$ are invariant under permutations
outside $L$.

\begin{proof} \
  \begin{enumerate}
    \item Straight forward induction.

    \item The proof for $\semantic{\tau}_L$ follows immediately with
          lemma~\ref{lemma:properties_of_Sigma_L}, the proofs for
          $\semantic{\tassn}_L$ and $\semantic{\ttarrow{\theta}{\pi}}_L$
          are trivial.
  \end{enumerate}
\end{proof}


%%
%% Total correctness
%%

\subsection{Total correctness}

\begin{definition}[Total correctness]
  Let $\tau\in\Type$, $e\in\CExp^\tau$, $\phi\in\semantic{\tassn}$, $\psi\in\semantic{\ttarrow{\tau}{\tassn}}$
  and $L\in W$. $e$ is {\em $L$-totally correct}, or {\em $L$-correct} for short, with respect to $\phi$ and
  $\psi$ if for all $s\in\Store_L$ with $\phi\,s=\true$: each computation for $(e,s)$ terminates with some
  $(v',s')$ such that $\psi\,v'\,s'=\true$. We write $L \models \triple{\phi}{e}{\psi}$ in this case.
\end{definition}

While the above definition reflects the usual understanding of {\em total correctness}, it is not really handy
in proving the soundness of the calculus later. This is because having to argue about all computations each
time is a tedious task. To get around this, we will show that it suffices to prove that if there exists a
terminating computation for $(e,s)$, then all possible computations terminate, and $\psi$ either holds for all
or none of the computations.

\begin{lemma}
  Let $\tau\in\Type$, $e\in\CExp^\tau$, $v'\in\CVal^\tau$, $s,s'\in\Store$
  and $R \in \PERM_{\dom{s}}$. If $(e,s)\xrightarrow*(v',s')$ then there
  exists a configuration $(v'',s'')$ such that
  \begin{enumerate}
    \item $(v',v'')\in R^\Exp$
    \item $(s',s'')\in R^\Sto$
    \item $(e,s) \xrightarrow* (v'',s'')$
  \end{enumerate}
\end{lemma}

{\bf TODO:} This is trivial with $v'' = v'$ and $s'' = s'$.

\begin{lemma}
  Let $\tau\in\Type$, $\psi\in\semantic{\ttarrow{\tau}{\tassn}}$,
  $e\in\CExp^\tau$, $v',v''\in\CVal^\tau$ and $s,s',s''\in\Store$
  with $\locns{e}\subseteq \dom{s}$, $\locns{v'}\subseteq\dom{s'}$
  and $\locns{v''}\subseteq \dom{s''}$.
  If $\supp{\psi} \subseteq \dom{s}$, $(e,s)\xrightarrow*(v',s')$
  and $(e,s)\xrightarrow*(v'',s'')$ then $\psi\,v'\,s'=\psi\,v''\,s''$.
\end{lemma}

\begin{lemma}[Total correctness]
  Let $\tau\in\Type$, $e\in\CExp^\tau$, $\phi\in\semantic{\tassn}$, $\psi\in\semantic{\ttarrow{\tau}{\tassn}}$
  and $L,L'\in W$.
  \begin{enumerate}
    \item If for every $s \in \Store_L$ with $\phi\,s=\true$ a $v'\in\CVal^\tau$ and a
          $s'\in\Store_L$ exist so that $(e,s) \xrightarrow* (v',s')$ and $\psi\,v'\,s'=\true$ then
          \[\begin{array}{rcl}
            L\models\triple{\phi}{e}{\psi}.
          \end{array}\]

    \item $\locns{e}\cup\supp{\phi}\cup\supp{\psi} \subseteq L \cap L'$ implies
          \[\begin{array}{rcl}
            L\models\triple{\phi}{e}{\psi} &\text{ iff }& L'\models\triple{\phi}{e}{\psi}.
          \end{array}\]
  \end{enumerate}
\end{lemma}

\begin{proof} \
  \begin{enumerate}
    \item

    \item Without loss of generality let $L= \locns{e}\cup\supp{\phi}\cup\supp{\psi}$ and hence $L \subseteq L'$.
          \begin{itemize}
            \item[`$\Rightarrow$']
                  Let $s\in\Store_{L'}$ with $\phi\,s=\true$. Since $\Store_{L'} \subseteq \Store_L$ we have
                  a $v\in\CVal^\tau$ and a $s'\in\Store_L$ such that $(e,s)\Downarrow(v,s')$ and
                  $\psi\,v\,s'=\true$. $s'\in\Store_{L'}$ since $L'\subseteq\dom{s}\subseteq\dom{s'}$.

            \item[`$\Leftarrow$']
          \end{itemize}
  \end{enumerate}
\end{proof}

From these results it is easy to see that the exact $L$ doesn't matter for the total correctness, since
if $L\models\triple{\phi}{e}{\psi}$ holds for some $L \supseteq \supp{\phi}\cup\locns{e}\cup\supp{\psi}$
then $L'\models\triple{\phi}{e}{\psi}$ holds for all $L'\supseteq \supp{\phi}\cup\locns{e}\cup\supp{\psi}$.
Hence we write $\triple{\phi}{e}{\psi}$ to denote that $e$ is {\em totally correct} with respect to
$\phi$ and $\psi$.

%\begin{definition}[Total correctness]
%  Let $\tau\in\Type$, $e\in\CExp^\tau$, $\phi\in\semantic{\tassn}$, $\psi\in\semantic{\ttarrow{\tau}{\tassn}}$
%  and $L\in W$. $e$ is {\em $L$-total correct}, or {\em $L$-correct} for short, with regard to $\phi$ and $\psi$ if for
%  all $s\in\Store_L$ with $\app{\phi}{s}=\true$ there exists a $v\in\CVal^\tau$ and a $s'\in\Store_L$,
%  for which $(e,s) \Downarrow (v,s')$ and $\app{\app{\psi}{v}}{s'} = \true$ holds. We write
%  $L \models \triple{\phi}{e}{\psi}$ in this case.
%\end{definition}
%
%\begin{lemma}[Total correctness]
%  Let $\tau\in\Type$, $e\in\CExp^\tau$, $\phi\in\semantic{\tassn}$, $\psi\in\semantic{\ttarrow{\tau}{\tassn}}$
%  and $L,L'\in W$. $\locns{e}\cup\supp{\phi}\cup\supp{\psi} \subseteq L \cap L'$ implies
%  \[\begin{array}{rcl}
%    L\models\triple{\phi}{e}{\psi} &\text{ iff }& L'\models\triple{\phi}{e}{\psi}.
%  \end{array}\]
%\end{lemma}
%
%\begin{proof}
%  Without loss of generality let $L= \locns{e}\cup\supp{\phi}\cup\supp{\psi}$ and hence $L \subseteq L'$.
%  \begin{itemize}
%    \item[`$\Rightarrow$']
%          Let $s\in\Store_{L'}$ with $\phi\,s=\true$. Since $\Store_{L'} \subseteq \Store_L$ we have
%          a $v\in\CVal^\tau$ and a $s'\in\Store_L$ such that $(e,s)\Downarrow(v,s')$ and
%          $\psi\,v\,s'=\true$. $s'\in\Store_{L'}$ since $L'\subseteq\dom{s}\subseteq\dom{s'}$.
%
%    \item[`$\Leftarrow$']
%  \end{itemize}
%\end{proof}



\end{document}
