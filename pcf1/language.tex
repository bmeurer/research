\documentclass[12pt,a4paper]{report}

\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amstext}
\usepackage{array}
\usepackage[american]{babel}
\usepackage{color}
\usepackage{enumerate}
\usepackage[a4paper,%
            colorlinks=false,%
            final,%
            pdfkeywords={},%
            pdftitle={},%
            pdfauthor={Benedikt Meurer},%
            pdfsubject={},%
            pdfdisplaydoctitle=true]{hyperref}
\usepackage[latin1]{inputenc}
\usepackage{latexsym}
\usepackage[final]{listings}
\usepackage{makeidx}
\usepackage[standard,thmmarks]{ntheorem}
\usepackage{stmaryrd}
\usepackage{url}
\usepackage[arrow, matrix, curve]{xy}

%% LaTeX macros
\include{macros}

% TODO
\newcommand{\CExp}{\nstyle{CExp}}
\newcommand{\CVal}{\nstyle{CVal}}
\newcommand{\Conf}{\nstyle{Conf}}
\newcommand{\Con}{\nstyle{Con}}
\newcommand{\Sto}{\nstyle{Sto}}
\newcommand{\scon}{\nstyle{con}}
\newcommand{\sexp}{\nstyle{exp}}
\newcommand{\ssto}{\nstyle{sto}}
\newcommand{\z}{\nstyle{int}}
\newcommand{\DEF}{\nstyle{DEF}}
\newcommand{\id}{\nstyle{id}}
\newcommand{\I}{\mathcal{I}}
\newcommand{\Fix}[1]{\nstyle{Fix}\,(#1)}
\newcommand{\returns}[2]{\ensuremath{\mathbf{returns}\,{#1}.\,{#2}}}


\begin{document}


%%
%% The programming language
%%

\chapter{The programming language}

As target language, we use eager PCF with the usual primitive types and imperative concepts.


%%
%% Abstract syntax
%%

\section{Abstract syntax}

We assume that infinite sets of variables $x \in \Var$ and locations $l \in \Loc$ are given;
variables are used to abstract expressions, locations are used to address memory cells.
Expressions are considered equal modulo renaming of bound variables.
$\Bool=\{\true,\false\}$ is the set of boolean constants $b$, $\Int$ is the set of integer
constants $z$; we do not distinguish between integer values and their program representation.

We assume an infinite set $\Loc$ of locations $l$.

\begin{definition}[Expressions]
  The set $\Op$ of {\em operators} $\op$ and the set $\Const$ of {\em constants} $c$
  are defined by the grammars
  \[\GRbeg
    \op \GRis + \GRmid - \GRmid * \GRmid = \GRmid < \GRmid > \GRmid \le \GRmid \ge \\
    c \GRis z \GRmid b \GRmid \unit \GRmid \cref \GRmid !
             \GRmid \assign \GRmid \fix,
  \GRend\]
  the set $\Exp$ of {\em expressions} $e$ is defined by
  \[\GRbeg
    e \GRis c \GRmid x \GRmid l \GRmid \abstr{x}{e} \GRmid \app{e_1}{e_2}
           \GRmid \ifte{e_0}{e_1}{e_2}
  \GRend\]
  and the set $\Val \subseteq \Exp$ of {\em values} $v$ is defined by
  \[\GRbeg
    v \GRis c \GRmid x \GRmid l \GRmid \abstr{x}{e} \GRmid \app{\op}{v} \GRmid \app{\assign}{v}
  \GRend\]
\end{definition}

$\free{e}$ denotes the set of free variables and $\locns{e}$ denotes the set of locations in the
expression $e$. We say that an expression $e$ is a {\em program} if both $\free{e}=\emptyset$
and $\locns{e}=\emptyset$ holds, that is if $e$ contains neither unbound variables nor
locations (i.e. memory addresses in terms of the underlying machine). We demand that all expressions
considered for the logic later are valid programs (i.e. programmers aren't permitted to access
abritrary memory locations).


%%
%% Static semantics
%%

\section{Static semantics}

The static semantics of the programming language are defined by the typing relation
$\tj{e}{\tau}$, with types $\tau$ as follows:

\begin{definition}[Types]
  The set $\Type$ of all {\em types} $\tau$ is defined by the context-free grammar below:
  \[\GRbeg
    \tau  \GRis \tbool \GRmid \tint \GRmid \tunit
          \GRal \tref{\tint}
          \GRal \tarrow{\tau_1}{\tau_2}
  \GRend\]
\end{definition}

We don't want to fiddle with type environments and store typings, hence we assume that
the elements of $\Var$ and $\Loc$ are already tagged with types. Therefore for every
type $\tau\in\Type$, let $\Var^\tau$ denote the set of variables $\tau$ and $\Loc^\tau$ the
set of locations of type $\tau$. Then $\Var=\bigcup_{\tau\in\Type}\Var^\tau$ and
$\Loc=\bigcup_{\tau\in\Type}\Loc^\tau$, where the $\Var^\tau$ and $\Loc^\tau$ are
required to be disjoint. We write $x^\tau$ to identify elements of $\Var^\tau$ and
$l^\tau$ for elements of $\Loc^\tau$.

\begin{definition}[Typing relation]
  A {\em typing judgement} is a formula $\tj{e}{\tau}$ with
  $e\in\Exp$ and $\tau\in\Type$. A typing judgement is said to
  be valid if it was derived using the typing rules {\bf defined
  elsewhere}.
\end{definition}

The set $\Exp^\tau = \{e\in\Exp\,|\,\tj{e}{\tau}\}$ includes all expressions of type $\tau$,
$\CExp^\tau = \{e\in\Exp^\tau\,|\,\free{e}=\emptyset\}$ is the subset of closed of expressions of
type $\tau$ and $\CExp = \bigcup_{\tau\in\Type} \CExp^\tau$ is the set of all well-typed, closed
expressions. Likewise we define $\Val^\tau = \Exp^\tau\cap\Val$, $\CVal^\tau = \CExp^\tau \cap \Val$
and $\CVal = \CExp \cap \Val$.


%%
%% Operational semantics
%%

\section{Operational semantics}

Let $(W,\subseteq) = (\powersetfin{Loc},\subseteq)$ be the partial order of possible `worlds'.

\begin{definition}[Store] \label{definition:Store} \
  \begin{enumerate}
    \item A {\em store} is a partial function $s:\Loc \pto \CVal$ with a finite domain and
          \begin{enumerate}
            \item $s(\Loc^\tau) \subseteq \CVal^\tau$ for every $\tau\in\Type$ and
            \item $\locns{s(\Loc)} \subseteq \dom{s}$.
          \end{enumerate}

    \item For every $L \in W$ the set of {\em $L$-stores} is defined as
          \[\begin{array}{l}
            \Store_L = \{s\,|\,\text{$s$ is a store with $L\subseteq\dom{s}$}\}.
          \end{array}\]

    \item $\Store = \bigcup_{L \in W} \Store_L$ denotes the set of all {\em stores}.
  \end{enumerate}
\end{definition}

We thereby require stores to be well-typed and closed by definition, i.e. we don't permit {\em dangling
references} within stores.

\begin{definition}[Configuration]
  Let $e\in\CExp$ and $s\in\Store$. The pair $(e,s)$ is a {\em configuration}
  if $\locns{e} \subseteq \dom{s}$. We let $\Conf$ denote the set of all configurations.
\end{definition}

The stores $s$ are already guaranteed to be closed due to definition~\ref{definition:Store} and
now expressions that appear as part of an evaluation are also required to be closed, i.e. do not
include {\em dangling references} to unallocated store cells.

%For any given set $L \subseteq \Loc$ we let $\Conf_L = \{(e,s)\in\Conf\,|\,\dom{s}\subseteq L\}$
%denote the subset of configurations which do not have locations allocated outside $L$.

\begin{definition}[Small step semantics]
  Let $k,k'\in\Conf$. A {\em small step} is a formula
  $k \to k'$. A small step is said to be valid if it was derived with
  the small rules given {\bf somewhere else}.
\end{definition}

\begin{definition}[Big step semantics]
  Let $k,k'\in\Conf$ with $k' \in \Val \times \Store$. A {\em big step} is a formula
  $k \Downarrow k'$. A big step is said to be valid if it was derived with the
  big step rules given {\bf somewhere else}.
\end{definition}

It is easy to see that both the small and the big step semantics are well defined
with respect to configurations. We assume that type safety holds for the semantics
(see Pierce, {\bf TODO}).

%\begin{lemma} \label{lemma:Small_steps_and_graph_of_stores}
%  Let $\tau\in\Type$, $e\in\CExp^\tau\setminus\Val$, $s,\hat{s}\in\Store_{\locns{e}}$.
%  If $\grph{s} \subseteq \grph{\hat{s}}$ then there exist $e',\hat{e}'\in\CExp^\tau$
%  and $s',\hat{s}'\in\Store$ such that
%  \begin{enumerate}
%    \item $(e,s) \to (e',s')$,
%    \item $(e,\hat{s}) \to (\hat{e}',\hat{s}')$ and
%    \item $\grph{s'} \subseteq \grph{\hat{s}'}$.
%  \end{enumerate}
%\end{lemma}
%
%\begin{proof}
%  By structural induction on $e$. We consider only the case for the application,
%  hence let $e = \app{e_1}{e_2}$.
%  \begin{itemize}
%    \item $e_1 \not\in \Val$, then by induction hypothesis, we have
%          $e_1',\hat{e_1}'\in\CExp^\tau$ and $s',\hat{s}'\in\Store$ such that
%          $(e_1,s) \to (e_1',s')$, $(e_1,\hat{s}) \to (\hat{e_1}',\hat{s}')$
%          and $\grph{s'} \subseteq \grph{\hat{s}'}$. With \RN{App-Left} we
%          conclude $(\app{e_1}{e_2},s) \to (\app{e_1'}{e_2},s')$ and
%          $(\app{e_1}{e_2},\hat{s}) \to (\app{\hat{e_1}'}{e_2},\hat{s}')$.
%
%    \item $e_1 \in \Val, e_2 \not\in \Val$ analogue to the above with \RN{App-Right}.
%
%    \item $e_1 = \cref, e_2=v\in \Val$, choose $e' = \hat{e}' = l \not\in \dom{\hat{s}} \subseteq \dom{s}$
%          and thereby $(e,s) \to (l,s[v/l])$ and $(e,\hat{s}) \to (l,\hat{s}[v/l])$ with \RN{Ref} and
%          $\grph{s'} = \grph{s} \cup \{(l,v)\} \subseteq \grph{\hat{s}} \cup \{(l,v)\} = \grph{\hat{s}'}$.
%
%    \item $e_1 = (\app{\assign}{l}), e_2 = v \in \Val$ where $l \in \dom{s}\cap\dom{\hat{s}}$, then
%          $(e,s) \to (\unit,s[v/l])$ and $(e,\hat{s}) \to (\unit,\hat{s}[v/l])$ with \RN{Assign} and
%          $\grph{s[v/l]}=\grph{s}\cup\{(l,v)\} \subseteq \grph{\hat{s}}\cup\{(l,v)\}=\grph{\hat{s}[v/l]}$.
%  \end{itemize}
%  The remaining cases are quite similar.
%\end{proof}
%
%\begin{corollary}
%  If $(e,s)$ has a terminating computation and $\grph{s} \subseteq \grph{s_1}$ then
%  there exist $v\in\CVal^\tau$, $s',s_1'\in\Store$ with
%  \begin{enumerate}
%    \item $(e,s) \xrightarrow* (v,s')$
%    \item $(e,s_1) \xrightarrow* (v,s_1')$
%    \item $\grph{s'} \subseteq \grph{s_1'}$
%  \end{enumerate}
%\end{corollary}
%
%\begin{proof}
%  Follows immediately with lemma~\ref{lemma:Small_steps_and_graph_of_stores}.
%\end{proof}

%%
%% Permutability
%%

\subsection{Permutability}

These permutations were inspired by the {\em partial bijections} used by Pitts ({\bf TODO}: citation);
but we prefer to use total bijections here, since we have to consider stores instead of just their domains.
The result will be similar since we will introduce a partial order on stores, which combined with the
total bijection on stores, results in something that is comparable to a partial bijection in the sense
of Pitts.

\begin{definition}[Permutation]
  A {\em permutation} is a total, bijective function $\mu:\Loc\to\Loc$ with
  $\mu\,(\Loc^\tau)=\Loc^\tau$ for each $\tau\in\Type$. Let $\Perm$ be the
  set of all such permutations.
\end{definition}

Let $\Fix{\mu} = \{l\in\Loc\,|\,\mu(l)=l\}$ be set the of all fixed points of $\mu$. Then
the set $\Fix{L} = \{\mu\in\Perm\,|\,L \subseteq \Fix{\mu}\}$ includes all
permutations $\mu$ with $(\mu|L) = \id_L$.

\begin{lemma}
  For all $L \subseteq \Loc$ and $\mu_1,\mu_2\in\Perm$ we have
  $\mu_1\in\Fix{L}$ iff $(\mu_2 \circ \mu_1 \circ \mu_2^{-1})\in\Fix{{\mu_2(L)}}$.
\end{lemma}

\begin{proof}
  Trivial.
\end{proof}

Now let $\Gamma = \{\scon,\sexp,\ssto\}$, where $\scon$ (= `configuration'),
$\sexp$ (= `expression') and $\ssto$ (= `store') are auxiliary symbols. For
every $\gamma \in \Gamma$ we define a poset $D^\gamma$ and for every $d \in D^\gamma$
we define a set $\supp{d} \in W$ -- called the {\em support} of $d$ -- by
\begin{itemize}
  \item $D^\sexp = (\Exp,\sqsubseteq_\Exp)$ \\
        $e \sqsubseteq_\Exp e' \,\Leftrightarrow\, e = e'$ \\
        $\supp{e} = \locns{e}$
  \item $D^\ssto = (\Store,\sqsubseteq_\Store)$ \\
        $s \sqsubseteq_\Store s' \,\Leftrightarrow\, \grph{s} \subseteq \grph{s'}$ \\
        $\supp{s} = \dom{s}$
  \item $D^\scon = (\Conf,\sqsubseteq_\Conf)$ \\
        $(e,s) \sqsubseteq_\Conf (e',s') \,\Leftrightarrow\, e \sqsubseteq_\Exp e' \wedge s \sqsubseteq_\Store s'$ \\
        $\supp{(e,s)} = \supp{e} \cup \supp{s}$
\end{itemize}
For every permutation $\mu \in \Perm$ and every $\gamma\in\Gamma$ we define
a function $\mu^\gamma:D^\gamma \to D^\gamma$ by
\begin{itemize}
  \item $\mu^\sexp\,e = e\mu$,
  \item $\mu^\ssto\,s = \mu^\sexp \circ s \circ \mu^{-1}$ and
  \item $\mu^\scon\,(e,s) = (\mu^\sexp\,e,\mu^\ssto\,s)$,
\end{itemize}
where $e\mu$ is the expression that results from applying $\mu$ to every location in $e$.

Obviously $\mu^\sexp$ is well-defined and bijective. For $\mu^\ssto$ assume that $L \in W$ and $s\in\Store_L$,
then $\mu^\ssto\,s = \mu^\sexp \circ s \circ \mu^{-1}$ is closed with respect to locations in
$\dom{\mu^\ssto\,s}$ and
\[\begin{array}{rccccl}
  \dom{\mu^\ssto\,s} &=& \mu(\dom{s}) &\supseteq& \mu(L),
\end{array}\]
thereby $(\mu^\ssto\,s) \in \Store_{\mu(L)}$. It is also easy to see that $\mu^\ssto$ is bijective, since
we have
\[\begin{array}{rcl}
  (\mu^{-1})^\ssto(\mu^\ssto\,s)
  &=& (\mu^{-1})^\ssto\,(\mu^\sexp \circ s \circ \mu^{-1}) \\
  &=& (\mu^{-1})^\sexp \circ \mu^\sexp \circ s \circ \mu^{-1} \circ \mu \\
  &=& s
\end{array}\]
for all $\mu\in\Perm$ and $s\in\Store$. Obviously $\mu^\scon$ is also well-defined and bijective then.

\begin{lemma}[Permutations] \label{lemma:Permutations}
  Let $\mu,\hat{\mu}\in\Perm$, $\gamma\in\Gamma$ and $d \in D^\gamma$, then
  \begin{enumerate}
    \item $\supp{\mu^\gamma\,d} = \mu\,(\supp{d})$
    \item $(\mu|\supp{d}) = (\hat{\mu}|\supp{d})$ implies $\mu^\gamma\,d = \hat{\mu}^\gamma\,d$
  \end{enumerate}
\end{lemma}
%
In the special case $\hat{\mu} = \id$ for the second property we conclude immediately that
$\supp{d} \subseteq \Fix{\mu}$ implies $\mu^\gamma\,d = d$ for all $\mu\in\Perm$, $d\in D^\gamma$.

\begin{proof}
  Trivial.
\end{proof}

\begin{theorem} \label{theorem:small_steps_and_permutations}
  Let $k_1,k_1',k_2,k_2'\in D^\scon$ and $\mu_1\in\Perm$ with
  $k_1 \to k_2$ and $k_1' = \mu_1^\scon\,k_1$. Then $k_1' \to k_2'$ iff there is a $\mu_2\in\Perm$
  with $\mu_1 =_{\supp{k_1}} \mu_2$ such that $k_2' = \mu_2^\scon\,k_2$.
\end{theorem}

The theorem is probably easier to understand if we visualize the implications using commutative
diagrams.
\[
  \xymatrix{
    k_1 \ar[r]^{\to} \ar[d]_{\mu_1} & k_2 \ar@{.>}[d]^{\mu_2} \\
    k_1' \ar[r]^{\to} & k_2'
  }
  \hspace*{3cm}
  \xymatrix{
    k_1 \ar[r]^{\to} \ar[d]_{\mu_1} & k_2 \ar[d]^{\mu_2} \\
    k_1' \ar@{.>}[r]^{\to} & k_2'
  }
\]

\begin{proof}
  $\mu^\sexp$ preserves the structure of expressions, hence the small steps $k_1 \to k_2$ and
  $k_1' \to k_2'$ (if they exist) must have been derived using the same small step rules. Therefore
  we can prove the theorem by induction on the length of the derivation of $k_1 \to k_2$.
  \begin{itemize}
    \item If $k_1 \to k_2$ was derived using rule \RN{Ref} then we have
          $k_1 = (\cref\,v,s)$,
          $k_2 = (l,s[v/l])$ with $l \not\in \dom{s}$
          and $k_1' = (\mu_1^\sexp(\cref\,v),\mu_1^\ssto\,s)$.
          \begin{itemize}
            \item[`$\Rightarrow$']
                  $k_2' = (l',(\mu_1^\ssto\,s)[\mu_1^\sexp\,v/l'])$ with $l' \not\in \dom{\mu_1^\ssto\,s}$

                  We can choose any $\mu_2 \in \Perm$ with $\mu_1 =_{\supp{k_1}} \mu_2$ and $\mu_2\,l = l'$ since
                  $l \not\in \dom{s} = \supp{k_1}$ and $(\mu_1^\ssto\,s)[\mu_1^\sexp\,v/l'] = \mu_2^\ssto(s[v/l])$.

            \item[`$\Leftarrow$']
                  $k_2' = (\mu_2\,l,\mu_2^\ssto(s[v/l]))$

                  $l \not\in \dom{s}$ implies $(\mu_2\,l)\not\in\mu_2(\dom{s})=\dom{\mu_2^\ssto\,s}=\dom{\mu_1^\ssto\,s}$,
                  and $\mu_2^\ssto(s[v/l]) = (\mu_2^\ssto\,s)[\mu_2^\sexp\,v/\mu_2\,l] = (\mu_1^\ssto\,s)[\mu_1^\sexp\,v/\mu_2\,l]$
                  and thereby we conclude
                  $(\mu_1^\sexp(\cref\,v),\mu_1^\ssto\,s)\to(\mu_2\,l,\mu_2^\ssto(s[v/l]))$ by small step rule \RN{Ref}.
          \end{itemize}

    \item If $k_1 \to k_2$ was derived using rule \RN{App-Left} then $k_1 = (e_1\,e_2,s)$,
          $k_2 = (e_1'\,e_2,s')$ and $k_1' = (\mu_1^\sexp(e_1\,e_2),\mu_1^\ssto\,s)$ with $(e_1,s) \to (e_1',s')$.
          \begin{itemize}
            \item[`$\Rightarrow$']
                  $k_2' = (\hat{e}_1'\,(\mu_1^\sexp\,e_2),\hat{s}')$ with
                  $(\mu_1^\sexp\,e_1,\mu_1^\ssto\,s) \to (\hat{e}_1',\hat{s}')$

                  By induction hypothesis there is a $\mu_2\in\Perm$ with $\mu_1 =_{\dom{s}} \mu_2$ such that
                  $\hat{e}_1' = \mu_2^\sexp\,e_1'$ and $\hat{s}' = \mu_2^\ssto\,s'$. Since
                  $\mu_1 =_{\dom{s}} \mu_2$ and $\dom{s} = \supp{k_1}$ we have $\mu_1^\sexp\,e_2=\mu_e^\sexp\,e_2$
                  and so we conclude $k_2' = (\mu_2^\sexp(e_1'\,e_2),\mu_2^\ssto\,s')$.

            \item[`$\Leftarrow$']
                  $k_2' = (\mu_2^\sexp(e_1'\,e_2),\mu_2^\ssto\,s')$

                  $\mu_2 =_{\supp{k_1}} \mu_1$ implies $\mu_2^\sexp\,e_2 = \mu_1^\sexp\,e_1$ and by induction hypothesis
                  a small step $(\mu_1^\sexp\,e_1,\mu_1^\ssto\,s) \to (\mu_2^\sexp\,e_1',\mu_2^\ssto\,s')$ exists. Then
                  $(\mu_1^\sexp(e_1\,e_2),\mu_1^\ssto\,s)\to(\mu_2^\sexp(e_1'\,e_2),\mu_2^\ssto\,s')$ follows immediately
                  with \RN{App-Left}.
          \end{itemize}
  \end{itemize}
  The remaining cases are omitted, they are similar to the above. 
\end{proof}

Now this theorem provides quite a lot of interesting results. For example, if we choose $\mu_1 = \id$ then we can
conclude that if $k_1 = k_1'$ has atleast one terminating computation, then all computations for $k_1$ terminate
with exactly the same number of steps, and for every two results $(v',s')$ and $(v'',s'')$ a permutation
$\mu_2 \in \Fix{\supp{k_1}}$ exists, such that $v' = \mu_2^\sexp\,v''$ and $v'' = \mu_2^\ssto\,s''$.

\begin{theorem} \label{theorem:small_steps_and_graph}
  Let $k_1,k_1',k_2\in D^\scon$. If $k_1 \sqsubseteq k_1'$ and $k_1' \to k_2'$ then
  there exists a $k_2 \in D^\scon$ such that $k_1 \to k_2$ and $k_2 \sqsubseteq k_2'$.
\end{theorem}

We can again visualize the theorem using a commutative diagram:
\[
  \xymatrix{
    k_1 \ar@{.>}[r]^{\to} \ar[d]_{\sqsubseteq} & k_2 \ar@{.>}[d]^{\sqsubseteq} \\
    k_1' \ar[r]^{\to} & k_2'
  }
\]

\begin{proof}
  By induction on $k_1' \to k_2'$:
  \begin{itemize}
    \item If $k_1' \to k_2'$ was derived using \RN{Ref} then $k_1 = (\cref\,v,s)$, $k_1' = (\cref\,v,s')$
          with $s \sqsubseteq k'$ and $k_2' = (l,s'[v/l])$ with $l \not\in \dom{s'}$.

          Now let $k_2 = (l,s[v/l])$. Since $l \not\in \dom{s'} \supseteq \dom{s}$ we can derive
          $k_1 \to k_2$ using \RN{Ref}.

    \item If $k_1' \to k_2'$ was derived by \RN{Assign} then $k_1 = (l \assign v,s)$, $k_1' = (l \assign v,s')$
          and $k_2' = (\unit,s'[v/l])$ with $s \sqsubseteq s'$.

          Then choose $k_2 = (\unit,s[v/l])$ since then $k_1 \to k_2$ with \RN{Assign} and obviously
          $(s[v/l]) \sqsubseteq (s'[v/l])$ since $s \sqsubseteq s'$ and $l \in \dom{s}\cap\dom{s'}$.

    \item If $k_1' \to k_2'$ was derived using \RN{App-Left} then $k_1=(e_1\,e_2,s_1)$, $k_1'=(e_1\,e_2,s_1')$
          and $k_2' = (e_1'\,e_2,s_2')$ with $s_1 \sqsubseteq s_1'$ and $(e_1,s_1') \to (e_1',s_2')$.

          By induction hypothesis there exists $s_2 \in D^\scon$ with $s_2 \sqsubseteq s_2'$ and
          $(e_1,s_1) \to (e_1',s_2)$. With \RN{App-Left} we conclude $(e_1\,e_2,s_1) \to (e_1'\,e_2,s_2)$.
  \end{itemize}
  The remaining cases are pretty similar in shape.
\end{proof}

Obviously this theorem implies that for every two stores $s,\hat{s}$ with $s \sqsubseteq \hat{s}$ and
$(e,\hat{s}) \xrightarrow* (v,\hat{s}')$ there exists another store $s'$ such that $(e,s) \xrightarrow* (v,s')$
and $s' \sqsubseteq \hat{s}'$.


%%
%% The assertion language
%%

\chapter{The assertion language}


%%
%% Syntax of the assertion language
%%

\section{Syntax of the assertion language}


%%
%% Semantics of the logic
%%

\section{Semantics of the logic}


%%
%% Reachability
%%

\subsection{Reachability}

\begin{definition}[Reachability]
  Let $L\in W$ and $s\in\Store_L$. By induction we define sets $\reachn{i}{L}{s} \subseteq \Loc$
  \begin{itemize}
    \item $\reachn{0}{L}{s} = L$
    \item $\reachn{i+1}{L}{s} = \reachn{i}{L}{s} \cup \bigcup_{l\in\reachn{i}{L}{s}} \locns{s(l)}$.
  \end{itemize}
  The set $\reach{L}{s} = \bigcup_{i\in\N} \reachn{i}{L}{s}$ includes all locations in $s$ reachable
  by $L$.
\end{definition}

Since a store $s\in\Store_L$ is always closed by definition, it is obvious that
$\reach{L}{s} \subseteq \dom{s} \in  W$ holds.

\begin{lemma}
  For all $L,L'\in W$ with $L \subseteq L'$ and $s,s'\in\Store_{L'}$ we have:
  \begin{enumerate}
    \item $\Store_{L'} \subseteq \Store_L$
    \item $\reach{L}{s} \subseteq \reach{L'}{s}$
    \item If $\reach{L'}{s} = \reach{L'}{s'}$ and $s(l) = s'(l)$ for every $l\in\reach{L'}{s}$,
          then $\reach{L}{s} = \reach{L}{s'}$.
  \end{enumerate}
\end{lemma}

\begin{proof}
  Trivial.
\end{proof}

\begin{definition}[$L$-equivalence, $L$-definability]
  Given a world $L \in W$ we define:
  \begin{enumerate}
    \item Two stores $s,s'\in\Store_L$ are {\em $L$-equivalent}, denoted $s \equiv_L s'$, if
          \begin{itemize}
            \item $\reach{L}{s} = \reach{L}{s'}$ and
            \item $\forall l\in\reach{s}{L}.\,s\,l=s'\,l$.
          \end{itemize}

    \item A predicate $\phi:\Store \pto \Bool$ with $\Store_L = \dom{\phi}$ is said to be
          {\em $L$-definable} if $\app{\phi}{s} = \app{\phi}{s'}$ for all stores
          $s,s'\in\Store_L$ with $s \equiv_L s'$. $\DEF_L$ denotes the set of all $L$-definable
          predicates.
  \end{enumerate}
\end{definition}

\begin{lemma}[$L$-definability] \label{lemma:L_definability}
  Let $L \in W$, $\phi \in \DEF_L$ and $s,s' \in \Store_L$. $s \sqsubseteq s'$ implies
  $\phi\,s = \phi\,s'$.
\end{lemma}

\begin{proof}
  Since $\phi \in \DEF_L$ we have $\phi\,s = \phi\,s'$ for all $s,s'$ with $s \equiv_L s'$. Hence
  it suffices to show that $s \sqsubseteq s'$ implies $s \equiv_L s'$.
  \[\begin{array}{rcl}
    s \sqsubseteq s'
    &\Rightarrow& \grph{s} \subseteq \grph{s'} \\
    &\Rightarrow& \dom{s} \subseteq \dom{s'} \wedge \forall l\in\dom{s}.\,s\,l = s'\,l \\
    &\Rightarrow& \reach{s}{L} = \reach{s'}{L} \wedge \forall l\in\reach{s}{L}.\,s\,l = s'\,l \\
    &           & \text{by a trivial induction since $\reach{s}{L} \subseteq \dom{s}$} \\
    &\Rightarrow& s \equiv_L s'
  \end{array}\]
\end{proof}

\begin{lemma}[Permutations and reachability] \label{lemma:Permutations_and_Reachability}
  Let $\mu \in \Perm$, $L \in W$, $s,s'\in\Store_L$ and $\phi:\Store\pto\Bool$.
  Then
  \begin{enumerate}
    \item $\reach{\mu(L)}{\mu^\ssto\,s} = \mu\,(\reach{L}{s})$
    \item $s \equiv_L s' \,\Leftrightarrow\, (\mu^\ssto\,s) \equiv_{\mu(L)} (\mu^\ssto\,s')$
    \item $\phi \in \DEF_{\mu(L)} \,\Leftrightarrow\, (\phi \circ \mu^\ssto) \in \DEF_L$
  \end{enumerate}
\end{lemma}

\begin{proof} \
  \begin{enumerate}
    \item It is sufficient to prove $\mu\,(\reachn{i}{L}{s}) = \reachn{i}{\mu(L)}{\mu^\ssto\,s}$ for every $i\in\N$:
          \begin{itemize}
            \item $\reachn{0}{\mu(L)}{\mu^\ssto\,s} = \mu(L) = \mu\,(\reachn{0}{L}{s})$

            \item $\reachn{i+1}{\mu(L)}{\mu^\ssto\,s} \\
                  = \reachn{i}{\mu(L)}{\mu^\ssto\,s}
                    \cup \bigcup_{l\in\reachn{i}{\mu(L)}{\mu^\ssto\,s}} \locns{s(l)} \\
                  = \mu\,(\reachn{i}{L}{s})
                    \cup \bigcup_{l\in\reachn{i}{L}{s}} \locns{\mu^\sexp(s(l)} \\
                  = \mu\,(\reachn{i+1}{L}{s})$
          \end{itemize}

    \item We prove only one direction, the reverse follows easily.

          $\reach{\mu(L)}{\mu^\ssto\,s} = \mu\,(\reach{L}{s}) = \mu\,(\reach{L}{s'}) = \reach{\mu(L)}{\mu^\ssto\,s'}$

          $l \in \reach{\mu(L)}{\mu^\ssto\,s} \\
            \,\Rightarrow\,
            \mu^{-1}(l) \in \reach{L}{s} \\
            \,\Rightarrow\,
            s(\mu^{-1}(l)) = s'(\mu^{-1}(l)) \\
            \,\Rightarrow\,
            (\mu^\ssto s)(l) = (\mu^\ssto s')(l)$

    \item Again only one direction.

          Let $s,s'\in\Store_L$ with $s \equiv_L s'$. Then $(\mu^\ssto\,s) \equiv_{\mu(L)} (\mu^\ssto\,s')$
          where $(\mu^\ssto\,s),(\mu^\ssto\,s')\in\Store_{\mu(L)}$, hence $\phi\,(\mu^\ssto\,s)=\phi\,(\mu^\ssto\,s')$
          and thereby $(\phi \circ \mu^\ssto) \in \DEF_L$.
  \end{enumerate}
\end{proof}


%%
%% Semantic domains
%%

\subsection{Semantic domains}

\begin{definition}[Semantic domains]
  For every type $\pi\in\LType$ we define {\em semantic domains} $\semantic{\pi} = (D^\pi,\I^\pi)$ where
  $D^\pi = \bigcup_{L \in W} D^\pi_L$ and $\I^\pi(\mu) : D^\pi \to D^\pi$ for every $\mu \in \Perm$ by
  \begin{itemize}
    \item $D^\tau_L = \{v\in\CVal^\tau\,|\,\supp{v} = L\}$ \\
          $\I^\tau(\mu): D^\tau \to D^\tau, v \mapsto \mu^\sexp\,v$

    \item $D^\tassn_L = \{ \phi\in\DEF_L\,|\,\forall \mu\in\Fix{L}.\,\phi = \phi \circ (\mu^\ssto)^{-1}\}$ \\
          $\I^\tassn(\mu): D^\tassn \to D^\tassn, \phi \mapsto \phi \circ (\mu^\ssto)^{-1}$

    \item $D^{\ttarrow{\theta}{\pi}}_L = \{ \psi: D^\theta \to D^\pi\,|\,
                          \forall L'\in W.\,\psi\,(D^\theta_{L'}) \subseteq D^\pi_{L \cup L'} \\
                          \hspace*{4.2cm} \wedge \forall \mu\in\Fix{L}.\,\psi=\mu^\pi\circ\psi\circ(\mu^\theta)^{-1}\}$\\
          $\I^{\ttarrow{\theta}{\pi}}(\mu): D^{\ttarrow{\theta}{\pi}} \to D^{\ttarrow{\theta}{\pi}},
                                            \psi \mapsto \I^\pi(\mu) \circ \psi \circ (\I^\theta(\mu))^{-1}$
  \end{itemize}
\end{definition}

We follow the usual mathematical convention and use $\semantic{\pi}$ not only as a notation
for the semantic domain $(D^\pi,\I^\pi)$ but also for the underlying set $D^\pi$,
hence $\semantic{\pi}_L$ denotes the set $D^\pi_L$. Moreover, we use $\mu^\pi$ as an abbreviation
for $\I^\pi(\mu)$.

Given lemma~\ref{lemma:Permutations}
it is pretty much obvious that $\mu^\pi\,d = d$ for every $d \in \semantic{\pi}_L$ and
$\mu\in\Fix{L}$.
It is also easy to see that
\[\begin{array}{rcl}
  \semantic{\pi}_{L_1} \cap \semantic{\pi}_{L_2} \ne \emptyset &\Rightarrow& L_1=L_2
\end{array}\]
holds for all $L_1,L_2\in W$. Thereby for each $d \in \semantic{\pi}$ a
unique world $L \in W$ exists, such that $d \in \semantic{\pi}_L$ and $d \not\in \bigcup_{L'\ne L} \semantic{\pi}_{L'}$.
This unique world $L$ is called the {\em support of $d$}, written $\supp{d}$. In general we abbreviate
$\supp{d_1,\ldots,d_n} = \bigcup_{i=1\ldots n}\supp{d_i}$.

\begin{lemma}[Semantic domains] \
  Let $\pi \in \LType$, $\mu\in\Perm$ and $L\in W$.
  \begin{enumerate}
    \item $(\mu^\pi|\semantic{\pi}_L): \semantic{\pi}_L \to \semantic{\pi}_{\mu(L)}$ is
          well-defined and bijective.
    \item $\mu^\pi: \semantic{\pi} \to \semantic{\pi}$ is well-defined and bijective.
  \end{enumerate}
\end{lemma}

\begin{proof}
  Given that $\semantic{\pi}$ is the union of disjoint sets $\semantic{\pi}_L$, the second
  property is simply an implication of the first one. Now assume that $(\mu^\pi|\semantic{\pi}_L)$
  is well-defined, i.e. $\mu^\pi\,\semantic{\pi}_L \subseteq \semantic{\pi}_{\mu(L)}$, then
  we also have $(\mu^{-1})^\pi\,\semantic{\pi}_{\mu(L)} \subseteq \semantic{\pi}_L$, which
  implies
  \[\begin{array}{rcl}
    (\mu^\pi \circ (\mu^{-1})^\pi)\,\semantic{\pi}_{\mu(L)} &\subseteq& \semantic{\pi}_{\mu(L)}
  \end{array}\]
  and
  \[\begin{array}{rcl}
    ((\mu^{-1})^\pi \circ \mu^\pi)\,\semantic{\pi}_L &\subseteq& \semantic{\pi}_L.
  \end{array}\]
%  \[\xymatrix{
%    \semantic{\pi}_L \ar@/^1pc/[r]^{\mu^\pi} &
%    \semantic{\pi}_{\mu(L)} \ar@/^1pc/[l]^{(\mu^{-1})^\pi}
%  }\]
  Given these results it is then sufficient to prove that $(\mu^\pi|\semantic{\pi}_L)$ is
  well-defined and $\mu^\pi \circ (\mu^{-1})^\pi$ is the identity on $\semantic{\pi}$.
  \begin{itemize}
    \item Let $v \in \semantic{\tau}_L$, then we have $\supp{v} = L$ and by lemma~\ref{lemma:Permutations}
          we also have $\mu(L) = \supp{\mu^\sexp\,v} = \supp{\mu^\tau\,v}$, thereby
          $(\mu^\tau\,v) \in \semantic{\tau}_{\mu(L)}$. Likewise
          $(\mu^\tau \circ(\mu^{-1})^\tau)\,v = \mu^\sexp((\mu^{-1})^\sexp\,v) = v$.

    \item Let $\phi \in \semantic{\tassn}_L$ then $\phi \in \DEF_{\mu^{-1}(\mu(L))}$ and using
          lemma~\ref{lemma:Permutations_and_Reachability} we conclude $(\phi\circ(\mu^\ssto)^{-1})\in\DEF_{\mu(L)}$.

          Now let $\bar{\mu}\in\Fix{\mu(L)}$ then $(\mu^{-1}\circ \bar{\mu} \circ \mu) \in \Fix{L}$ and since
          $\phi\in\DEF_L$ we also have $\phi = \phi \circ ((\mu^{-1}\circ \bar{\mu} \circ \mu)^\ssto)^{-1}$,
          which easily transforms to $\phi\circ (\mu^\ssto)^{-1} = \phi \circ (\mu^\ssto)^{-1} \circ (\bar{\mu}^\ssto)^{-1}$.

          Obviously $(\mu^\tassn\circ(\mu^{-1})^\tassn)\,\phi = (\mu^{-1})^\ssto(\mu^\ssto\,\phi) = \phi$.

    \item For $\mu^{\ttarrow{\theta}{\pi}}$ the statement follows immediately using the induction hypothesis.
%    \item Let $\psi\in\semantic{\ttarrow{\theta}{\pi}}_L$, then
%          \begin{itemize}
%            \item $d \in \semantic{\theta}_{L'}, L'\in W \\
%                   \,\Rightarrow\,
%                   ((\mu^\theta)^{-1}\,d) \in \semantic{\theta}_{\mu^{-1}(L')} \\
%                   \,\Rightarrow\,
%                   \psi\,((\mu^\theta)^{-1}\,d) \in \semantic{\pi}_{L\cup\mu^{-1}(L')} \\
%                   \,\Rightarrow\,
%                   \mu^\pi\,(\psi\,((\mu^\theta)^{-1}\,d))\in\semantic{\pi}_{\mu(L)\cup L'} \\
%                   \,\Rightarrow\,
%                   ((\mu^\pi\circ\psi\circ(\mu^\theta)^{-1})\,d)\in\semantic{\pi}_{\mu(L)\cup L'}$
%
%            \item $\bar{\mu}\in\Perm_{\mu(L)} \\
%                   \,\Rightarrow\,
%                   (\mu^{-1}\circ \bar{\mu} \circ \mu) \in \Fix{L} \\
%                   \,\Rightarrow\,
%                   \psi = (\mu^{-1}\circ\bar{\mu}\circ\mu)^\pi\circ\psi\circ
%                      ((\mu^{-1}\circ\bar{\mu}\circ\mu)^\theta)^{-1} \\
%                   \,\Rightarrow\,
%                   \psi = (\mu^\pi)^{-1}\circ\bar{\mu}^\pi\circ\mu^\pi\circ\psi
%                      \circ(\mu^\theta)^{-1}\circ(\bar{\mu}^\theta)^{-1}\circ\mu^\theta \\
%                   \,\Rightarrow\,
%                   \mu^\pi \circ \psi \circ (\mu^\theta)^{-1}
%                      = \bar{\mu}^\pi\circ[\mu^\pi\circ\psi\circ(\mu^\theta)^{-1}]\circ(\bar{\mu}^\theta)^{-1}$
%          \end{itemize}
%          so we conclude $(\mu^{\ttarrow{\theta}{\pi}}\,\psi)\in\semantic{\ttarrow{\theta}{\pi}}_{\mu(L)}$.
%
%          Given $\mu^\theta\circ(\mu^{-1})^\theta = \id_{\semantic{\theta}}$ and
%          $\mu^\pi\circ(\mu^{-1})^\pi = \id_{\semantic{\pi}}$ by induction hypothesis it follows easily that
%          \[\begin{array}{rcccl}
%            (\mu^{\ttarrow{\theta}{\pi}}\circ (\mu^{-1})^{\ttarrow{\theta}{\pi}})\,\psi
%            &=& \mu^\pi \circ (\mu^{-1})^\pi \circ \psi \circ (\mu^{-1})^\theta \circ \mu^\theta 
%            &=& \psi.
%          \end{array}\]
  \end{itemize}
\end{proof}

\begin{lemma} \label{lemma:Permutations_and_semantic_domains}
  Let $\mu,\hat{\mu}\in\Perm$, $\pi\in\LType$ and $d \in \semantic{\pi}$, then
  $\mu^\pi\,d = \hat{\mu}^\pi\,d$ if
  $(\mu|\supp{d}) = (\hat{\mu}|\supp{d})$.
\end{lemma}

\begin{proof}
  Follows easily with lemma~\ref{lemma:Permutations}.
\end{proof}


%%
%% Total correctness
%%

\subsection{Total correctness}

\begin{definition}[Total correctness]
  Let $\tau\in\Type$, $e\in\CExp^\tau$, $\phi\in\semantic{\tassn}$, $\psi\in\semantic{\ttarrow{\tau}{\tassn}}$
  and $L\in W$ with $\supp{\phi,e,\psi} \subseteq L$.
  $e$ is {\em $L$-totally correct}, or {\em $L$-correct} for short, with respect to $\phi$ and
  $\psi$, if for every $s\in\Store_L$ with $\phi\,s=\true$ each computation for $(e,s)$ terminates with some
  $(v',s')$ such that $\psi\,v'\,s'=\true$. We write $L \models \triple{\phi}{e}{\psi}$ in this case.
\end{definition}

While the above definition reflects the usual understanding of {\em total correctness}, it is not really handy
in proving the soundness of the calculus later. This is because having to argue about all computations each
time is a tedious task. To get around this, we will show that it suffices to prove that if there exists a
terminating computation for $(e,s)$, then all possible computations terminate, and $\psi$ either holds for all
or none of the computations.

Furtheron it is unusual to talk about a specific world $L$ in which $e$ is totally correct. Instead, one would
like to say that $e$ is totally correct with respect to $\phi$ and $\psi$, without talking about the world
explicitly. Hence we will show that if $e$ is totally correct in a sufficiently large world, then $e$ is
totally correct in all such worlds and we don't need to talk about the exact $L$ anymore.

\begin{lemma}[Total correctness]
  Let $\tau\in\Type$, $e\in\CExp^\tau$, $\phi\in\semantic{\tassn}$, $\psi\in\semantic{\ttarrow{\tau}{\tassn}}$
  and $L,L'\in W$ with $\supp{\phi,e,\psi} \subseteq L \cap L'$.
  \begin{enumerate}
    \item $L\models\triple{\phi}{e}{\psi}$ if for every $s \in \Store_L$ with $\phi\,s=\true$ there exist $v'\in\CVal^\tau$ and 
          $s'\in\Store$ such that $(e,s) \xrightarrow* (v',s')$ and $\psi\,v'\,s'=\true$.

    \item $L\models\triple{\phi}{e}{\psi}$ iff $L'\models\triple{\phi}{e}{\psi}$.
  \end{enumerate}
\end{lemma}

\begin{proof} \
  \begin{enumerate}
    \item Let $s \in \Store_L$ with $\phi\,s = \true$. If there exists a terminating computation $(e,s) \xrightarrow* (v',s')$
          then theorem~\ref{theorem:small_steps_and_permutations} guarantees that each computation for $(e,s)$
          terminates with some $(v'',s'')$ such that a permutation $\mu\in\Fix{\dom{s}}$ exists with
          $\mu^\tau\,v' = \mu^\sexp\,v' = v''$ and $\mu^\ssto\,s' = s''$.
          Hence it suffices to prove that $\psi\,v'\,s' = \psi\,(\mu^\tau\,v')\,(\mu^\ssto\,s')$.

          Since $\supp{\psi} \subseteq \dom{s} \subseteq \Fix{\mu}$ we have $\psi = (\mu^{\ttarrow{\tau}{\tassn}})^{-1}\,\psi$ by
          lemma~\ref{lemma:Permutations_and_semantic_domains} and so
          \[\begin{array}{rcl}
            \psi\,v'\,s' &=& ((\mu^\tassn)^{-1} \circ \psi \circ \mu^\tau)\,v'\,s' \\
                         &=& ((\mu^\tassn)^{-1} (\psi\,(\mu^\tau\,v')))\,s' \\
                         &=& \psi\,(\mu^\tau\,v')\,(\mu^\ssto\,s').
          \end{array}\]

    \item Without loss of generality let $L= \supp{\phi,e,\psi}$ and hence $L \subseteq L'$.
          \begin{itemize}
            \item[`$\Rightarrow$']
                  Trivial since $\Store_{L'} \subseteq \Store_L$.

            \item[`$\Leftarrow$']
                  Let $s \in \Store_L$ with $\phi\,s = \true$. Then we are able to construct a store $\hat{s}\in\Store_{L'}$
                  with $s \sqsubseteq \hat{s}$, and by lemma~\ref{lemma:L_definability} we also have $\phi\,\hat{s}=\true$
                  then.

                  Since $(e,\hat{s})$ is a well-typed configuration, there must be atleast one computation such that
                  $(e,\hat{s}) \xrightarrow* (v,\hat{s}')$ for which, by assumption, $\psi\,v\,\hat{s}'=\true$ holds.
                  Now theorem~\ref{theorem:small_steps_and_graph} guarantees that a store $s'$ exists such that
                  $(e,s) \xrightarrow* (v,s')$ and $s' \sqsubseteq \hat{s}'$.

                  Since $(\psi\,v) \in \semantic{\tassn}_{\supp{\psi,v}}$ and 
                  $\supp{\psi,v}\subseteq\dom{s'}\subseteq\dom{\hat{s}'}$ we have $\psi\,v\,s' = \true$ by
                  lemma~\ref{lemma:L_definability}, and therefore we conclude $L\models\triple{\phi}{e}{\psi}$.
          \end{itemize}
  \end{enumerate}
\end{proof}

From these results it is easy to see that the exact $L$ doesn't matter for the total correctness, since
if $L\models\triple{\phi}{e}{\psi}$ holds for some $L \supseteq \supp{\phi,e,\psi}$
then $L'\models\triple{\phi}{e}{\psi}$ holds for all $L'\supseteq \supp{\phi,e,\psi}$.
Hence we write $\triple{\phi}{e}{\psi}$ if $\supp{\phi,e,\psi}\models\triple{\phi}{e}{\psi}$,
to denote that $e$ is {\em totally correct} with respect to $\phi$ and $\psi$.


\end{document}
